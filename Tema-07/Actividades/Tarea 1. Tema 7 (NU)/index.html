<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cesta mejoreada</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

    <style>
        .derecha {
            text-align: right;
        }

        span {
            font-size: 60px;
            vertical-align: middle;
        }
    </style>

    <script>
        class Producto {

            constructor(id, imagen, nombre, precio) {
                this.id = id;
                this.imagen = imagen;
                this.nombre = nombre;
                this.precio = precio;
            }
        }

        class ContProductos {
            #productos;
            constructor(productos) {
                this.#productos = productos;
                this.mostrarProductos();

            }

            mostrarProductos() {
                // Obtenemos el id del div en el que insertaremos los productos
                const contenedor = document.getElementById("cards-container");

                // Recorremos el array de objetos de productos y vamos llamando al método crearProducto
                this.#productos.forEach(datos => {
                    var nuevaTarjeta = this.crearProducto(datos);
                    // Añadimos el nuevo producto al contenedor
                    contenedor.appendChild(nuevaTarjeta);
                });

            }

            crearProducto(productos) {
                // Creamos la plantilla para los productos
                var card = document.createElement("card");
                card.classList.add('card');


                var cardImagen = document.createElement("img");
                cardImagen.src = productos.imagen;

                var cardNombre = document.createElement("h4");
                cardNombre.innerHTML = productos.nombre;

                var cardImput = document.createElement("input");
                cardImput.type = 'number';
                cardImput.placeholder = 'Inserte cantidad';

                var cardPrecio = document.createElement("p");
                cardPrecio.innerHTML = productos.precio;

                var cardBoton = document.createElement("button");
                cardBoton.innerHTML = 'Añadir';
                cardBoton.classList.add('btn');
                cardBoton.classList.add('btn-primary');

                // Proceso para asociar el botón a la cesta
                // Asignamos automáticamente un id por orden a cada botón
                cardBoton.dataset.id = productos.id;

                // Añadimos el event listener
                cardBoton.addEventListener('click', () => {
                    const productoId = productos.id;

                    const cantidad = parseInt(cardImput.value);

                    if (cantidad <= 0 || isNaN(cantidad)) {
                        alert("Introduzca un número de productos válido");
                        return;
                    } else if (cantidad > 0) {
                        miCesta.añadirProducto(productoId, cantidad);
                    }
                });




                card.appendChild(cardImagen);
                card.appendChild(cardNombre);
                card.appendChild(cardImput);
                card.appendChild(cardPrecio);
                card.appendChild(cardBoton);

                return card;



            }

        }
        class Cesta {
            #cesta = [];
            #productos;

            constructor(productos) {
                this.#productos = productos;
                this.cargarProducto();
            }

            añadirProducto(productoId, cantidad) {
                const elementoExiste = this.#cesta.find(producto => producto.id === productoId);

                if (!elementoExiste) {
                    this.#cesta.push({ id: productoId, cantidad: cantidad });
                } else {
                    elementoExiste.cantidad += cantidad;
                }

                this.mostrarCesta();
                this.guardarProducto();


            }
            guardarProducto() {
                localStorage.clear();
                localStorage.setItem("datos", JSON.stringify(this.#cesta));

            }

            cargarProducto() {
                let datos = localStorage.getItem("datos");
                let cesta = JSON.parse(datos);

                if (cesta != null) {
                    this.#cesta = cesta;

                }
                this.mostrarCesta();
            }

            crearFila(producto, itemCesta) {

                var fila = document.createElement('tr')
                fila.classList.add('tr');

                var filaId = document.createElement('td');
                filaId.innerHTML = itemCesta.id;

                var filaNombre = document.createElement('td');
                filaNombre.innerHTML = producto.nombre;

                var filaCantidad = document.createElement('td');
                filaCantidad.innerHTML = itemCesta.cantidad;

                var filaPrecio = document.createElement('td');
                filaPrecio.innerHTML = producto.precio.toFixed(2) + "€";

                var subtotal = producto.precio * itemCesta.cantidad;
                var filaSubtotal = document.createElement('td');
                filaSubtotal.innerHTML = subtotal.toFixed(2) + " €";

                var filaBorrarCelda = document.createElement('td'); // Celda para el botón de borrar
                var filaBorrarBoton = document.createElement('button');
                filaBorrarBoton.innerText = "Borrar";
                filaBorrarBoton.classList.add("btn", "btn-danger", "btn-sm");

                filaBorrarBoton.addEventListener('click', () => {
                    // Obtenemos el id del producto
                    const idAEliminar = itemCesta.id;

                    // llamamos al método de borrado
                    this.eliminarProducto(idAEliminar);
                });

                filaBorrarCelda.appendChild(filaBorrarBoton);



                fila.appendChild(filaId);
                fila.appendChild(filaNombre);
                fila.appendChild(filaCantidad);
                fila.appendChild(filaPrecio);
                fila.appendChild(filaSubtotal);
                fila.appendChild(filaBorrarCelda);


                return fila;

            }



            actualizarTotales(total) {
                const totalElement = document.getElementById('totalSinIva');
                const totalIvaElement = document.getElementById('totalConIva');
                const multiplicacionIva = 1.21;
                const totalConIva = total * multiplicacionIva;

                totalElement.innerHTML = `Total: ${total.toFixed(2)} €`;
                totalIvaElement.innerHTML = `Total + IVA (21%): ${totalConIva.toFixed(2)} €`;
            }

            mostrarCesta() {
                let contenedorCesta = document.getElementById("cestaProductos");
                contenedorCesta.innerHTML = '';

                let totalCesta = 0;

                for (let item of this.#cesta) {
                    const productoCompleto = this.#productos.find(prod => prod.id === item.id);

                    if (productoCompleto) {
                        // Creamos la fila
                        const nuevaFila = this.crearFila(productoCompleto, item);
                        contenedorCesta.appendChild(nuevaFila);

                        // Sumamos al subtotal
                        totalCesta += productoCompleto.precio * item.cantidad;
                    }

                }
                this.actualizarTotales(totalCesta);

            }

            eliminarProducto(productoId) {
                // filter mantiene todos los productos cuyo id no coincida con el que queremos borrar
                this.#cesta = this.#cesta.filter(item => item.id !== productoId);

                // Actualizamos la vista 
                this.mostrarCesta();
                this.guardarProducto();
            }

        }

        var productos = [
            new Producto(1, "img/monsuno.jpg", "Monsuno", 10),
            new Producto(2, "img/bayblade.jpg", "Bayblade", 15),
            new Producto(3, "img/zomling.jpg", "Zombligs", 5),
            new Producto(4, "img/bakugans.jpg", "Bakugans", 12),
            new Producto(5, "img/estampitas.jpg", "Estampitas", 3),
            new Producto(6, "img/cromos.jpg", "Cromos", 35)
        ];


        var miCesta;
        var miContenedorProductos;

        window.onload = () => {
            // Inicializamos la clase que dibuja los productos
            miContenedorProductos = new ContProductos(productos);

            // Inicializamos la cesta DESPUÉS.
            miCesta = new Cesta(productos);
        };


    </script>
</head>

<body>


    <div class="container text-center">
        <div class="row">
            <div class="col">
                <header>
                    <h1>The Childhood Store</h1>
                    <h4>Ejemplo de cesta dinámica</h4>
                </header>
            </div>
        </div>
        <div class="row row-cols-2">
            <div class="col">
                <div class="container text-center">
                    <div id="cards-container" class="row row-cols-3">

                    </div>
                </div>
            </div>
            <div class="col">
                <img src="https://img.icons8.com/shopping-basket" alt="">
                <span>Cesta</span>
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">Cod.</th>
                            <th scope="col">Nombre</th>
                            <th scope="col">Cantidad</th>
                            <th scope="col">Precio (€)</th>
                            <th scope="col">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody id="cestaProductos">
                    </tbody>

                </table>
                <p id="totalSinIva" class="derecha">Total: €</p>
                <p id="totalConIva" class="derecha">Total + IVA (21%): €</p>
            </div>
        </div>
    </div>

</body>

</html>