<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <style>
        .centra {
            border: 1px solid grey;
            text-align: center;
        }

        .borde {
            border: 1px solid grey;
        }

        .negrita {
            font-weight: bold;
        }
    </style>

</head>

<body>
    <script>

        // Cadena 'bdDallo', contiene todos los costes en euros (materiales, mano de obra, etc...)
        //  para realizar el escandallo de una serie de carteras de piel recibido desde una BBDD.

        const bdDallo = `[{ "cod": 1,
                        "descrip": "cartera piel vacuno negra",
                        "costos":{ "piel": 5,
                                   "hilo": 0.80,
                                   "rebaje": 1,
                                   "pegamento": 0.50,
                                   "pintura": 0.45,
                                   "broches": 0.90,
                                   "cosido": 1,
                                   "fabricación": 15,
                                   "embasado": 1}                
                   },
                   {    "cod": 2,
                        "descrip": "cartera piel vacuno azul",
                        "costos":{ "piel": 6,
                                   "hilo": 0.90,
                                   "rebaje": 1.50,
                                   "pegamento": 0.70,
                                   "pintura": 0.50,
                                   "broches": 0.80,
                                   "cosido": 1.50,
                                   "fabricación": 16,
                                   "embasado": 1.20}                
                   },
                   {    "cod": 3,
                        "descrip": "cartera piel coco",
                        "costos":{ "piel": 25,
                                   "hilo": 1,
                                   "rebaje": 1,
                                   "pegamento": 0.70,
                                   "pintura": 0.80,
                                   "broches": 1,
                                   "cosido": 3,
                                   "fabricación": 20,
                                   "embasado": 5}               
                   }]`

        // Clase para crear las secciones de la tabla (filas de cabecera, producto, costes y total)
        class Secc {
            constructor() {
            }

            // Crea la fila de cabecera (COD, DESCRIPCIÓN, COSTO €)
            crearCabecera() {
                let cabecera = document.createElement('tr');

                let cod = document.createElement('td');
                cod.innerHTML = 'COD';
                cod.classList.add('centra');

                let descripcion = document.createElement('td');
                descripcion.innerHTML = 'DESCRIPCIÓN';
                descripcion.classList.add('centra');


                let costos = document.createElement('td');
                costos.innerHTML = 'COSTO €';
                costos.classList.add('centra');



                cabecera.appendChild(cod);
                cabecera.appendChild(descripcion);
                cabecera.appendChild(costos);

                return cabecera;
            }

            // Crea la fila principal con el código y nombre del producto
            crearModeloCartera(id, nombre) {
                let producto = document.createElement('tr');

                let idProducto = document.createElement('td');
                idProducto.innerHTML = id;
                idProducto.classList.add('borde');

                let nombreProducto = document.createElement('td');
                nombreProducto.innerHTML = nombre;
                nombreProducto.classList.add('negrita');
                nombreProducto.classList.add('borde');

                let espacio = document.createElement('td'); // Celda vacía para alinear
                espacio.classList.add('borde');

                producto.appendChild(idProducto);
                producto.appendChild(nombreProducto);
                producto.appendChild(espacio);

                return producto;
            }

            // Crea una fila para cada coste  
            crearCostes(costes) {
                let filasCostos = [];

                // Recorre todos los costes del producto (piel, hilo, etc.)
                for (const claveCosto in costes) {
                    let trCostes = document.createElement('tr');

                    let espacio = document.createElement('td'); // Celda vacía
                    espacio.classList.add('borde');

                    let elementoNombre = document.createElement('td');
                    elementoNombre.innerHTML = claveCosto; // Nombre del coste 
                    elementoNombre.classList.add('borde');

                    // Controladores de eventos con funcionalidad al pasar el ratón
                    elementoNombre.setAttribute('onmouseover', 'this.style.borderColor="blue"; this.style.borderWidth="3px"');
                    elementoNombre.setAttribute('onmouseout', 'this.style.borderColor="black"; this.style.borderWidth="1px"');


                    let cost = document.createElement('td');
                    cost.innerHTML = costes[claveCosto] + ' €'; // Valor del coste
                    cost.classList.add('borde');

                    trCostes.appendChild(espacio);
                    trCostes.appendChild(elementoNombre);
                    trCostes.appendChild(cost);

                    filasCostos.push(trCostes); // Guardamos la fila creada en un array

                }

                return filasCostos; // Devuelve todas las filas de costes
            }

            // Calcula y crea la fila con el Coste Total
            crearTotal(costes) {
                let total = 0;

                // Suma todos los valores de costes
                for (const claveCosto in costes) {
                    total += parseFloat(costes[claveCosto]);
                }

                let filaTotal = document.createElement('tr');

                let espacio = document.createElement('td'); // Celda vacía

                let totalEstatico = document.createElement('td');
                totalEstatico.innerHTML = 'Total:'; 
                totalEstatico.classList.add('borde');
                totalEstatico.classList.add('negrita');


                let resultadoTotal = document.createElement('td');
                resultadoTotal.innerHTML = total.toFixed(2) + ' €'; // Muestra el total redondeado
                resultadoTotal.classList.add('borde');
                resultadoTotal.classList.add('negrita');

                filaTotal.appendChild(espacio);
                filaTotal.appendChild(totalEstatico);
                filaTotal.appendChild(resultadoTotal);

                return filaTotal;
            }
        }

        // Clase principal que imprime la tabla en pantalla
        class Tabla {
            #dallo; // Variable privada para los datos del escandallo
            #secc; // Variable privada para la instancia de la clase Secc

            constructor(dallo) {
                this.#dallo = JSON.parse(bdDallo) // Parseamos la cadena JSON
                this.#secc = new Secc(dallo); 
                this.render(); // Llama al método para dibujar la tabla
            }

            // Método para construir y mostrar la tabla en la web
            render() {
                let tabla = document.createElement('table'); // Crea la tabla
                tabla.classList.add('table');
                let thead = document.createElement('thead'); // Crea la cabecera de la tabla
                let tbody = document.createElement('tbody'); // Crea el cuerpo de la tabla

                let cabecera = this.#secc.crearCabecera(); // Obtiene la fila de cabecera

                // Itera sobre cada cartera 
                for (let i = 0; i != this.#dallo.length; i++) {
                    // Crea y añade la fila del nombre del producto
                    let producto = this.#secc.crearModeloCartera(this.#dallo[i].cod, this.#dallo[i].descrip);
                    tbody.appendChild(producto);

                    // Obtiene todas las filas de costes de ese producto
                    let filasCostes = this.#secc.crearCostes(this.#dallo[i].costos);
                    // Añade al cuerpo de la tabla cada fila de coste individual
                    for (const fila of filasCostes) {
                        tbody.appendChild(fila);
                    }

                    // Crea y añade la fila del coste total del producto
                    let filaTotal = this.#secc.crearTotal(this.#dallo[i].costos);
                    tbody.appendChild(filaTotal);


                }


                thead.appendChild(cabecera); // Añade la cabecera al encabezado



                tabla.appendChild(thead); // Añade el encabezado a la tabla
                tabla.appendChild(tbody); // Añade el cuerpo a la tabla

                let addTabla = document.body.appendChild(tabla); // Muestra la tabla en el body del documento

                return addTabla;
            }
        }




        new Tabla(bdDallo); // Inicia el proceso: Crea la tabla al cargar la página

    </script>
</body>

</html>